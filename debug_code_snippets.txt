=========================================
â‘  uploadMemoryImage() é–¢æ•°ã‚³ãƒ¼ãƒ‰å…¨ä½“
=========================================
async uploadMemoryImage(file, userId) {
    if (!file || !userId) throw new Error('fileã¾ãŸã¯userIdãŒæœªå®šç¾©ã§ã™');
    
    const filename = `${Date.now()}_${file.name}`;
    const storageRef = firebase.storage().ref(`images/${userId}/${filename}`);
    const snapshot = await storageRef.put(file);
    const downloadURL = await snapshot.ref.getDownloadURL();
    return downloadURL;
}

=========================================
â‘¡ saveMemory() é–¢æ•°ã‚³ãƒ¼ãƒ‰å…¨ä½“
=========================================
async saveMemory() {
    const date = document.getElementById('memoryDate').value;
    const category = document.getElementById('memoryCategory').value;
    const content = document.getElementById('memoryContent').value;
    const imageFile = document.getElementById('memoryImage').files[0];
    
    console.log('Saving memory:', { date, category, content, hasImage: !!imageFile });
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!date || !content) {
        this.showNotification('æ—¥ä»˜ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }

    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯AIæ„Ÿæƒ…åˆ†æProã‚’ä½¿ç”¨
    let emotion;
    if (this.storageManager.currentPlan === 'premium') {
        const proAnalysis = await this.aiEmotionPro.analyzeEmotionPro(content);
        if (proAnalysis.success) {
            emotion = {
                dominant: proAnalysis.analysis.basic.dominant,
                analysis: proAnalysis.analysis.basic.dominant + ' ' + 
                         (proAnalysis.analysis.advanced?.emotions?.primary || ''),
                scores: proAnalysis.analysis.basic.scores,
                advanced: proAnalysis.analysis.advanced
            };
        } else {
            emotion = this.analyzeEmotion(content);
        }
    } else {
        emotion = this.analyzeEmotion(content);
    }

    const memory = {
        id: Date.now(),
        date: date,
        category: category,
        content: content,
        emotion: emotion,
        timestamp: new Date().toISOString()
    };

    console.log('Memory object created:', memory);

    if (imageFile) {
        console.log('Image file detected:', imageFile.name, imageFile.type, imageFile.size);
        
        // ç”»åƒã‚¿ã‚¤ãƒ—ã®ç¢ºèª
        if (!imageFile.type.startsWith('image/')) {
            console.error('Invalid file type:', imageFile.type);
            this.showNotification('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèª
        const fileSizeInMB = imageFile.size / (1024 * 1024);
        console.log(`ç”»åƒã‚µã‚¤ã‚º: ${fileSizeInMB.toFixed(2)}MB`);
        
        // ç”»åƒã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ5MBï¼‰
        if (fileSizeInMB > 5) {
            this.showNotification('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        // Firebase Authenticationç¢ºèª
        const user = firebase.auth().currentUser;
        if (!user) {
            this.showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        try {
            this.showNotification('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
            
            // uploadMemoryImageé–¢æ•°ã‚’ä½¿ç”¨
            const imageUrl = await this.uploadMemoryImage(imageFile, user.uid);
            console.log('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:', imageUrl);
            
            // ãƒ¡ãƒ¢ãƒªãƒ¼ã«imageUrlã‚’è¨­å®š
            memory.imageUrl = imageUrl;
            console.log('âœ… ä¿å­˜ã•ã‚Œã‚‹URL:', memory.imageUrl);
            
            this.showNotification('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'success');
            this.addMemory(memory);
            
        } catch (error) {
            console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            this.showNotification('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            
            // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç”»åƒãªã—ã§ä¿å­˜ã™ã‚‹ã‹ç¢ºèª
            if (confirm('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒãªã—ã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
                this.addMemory(memory);
            }
        }
    } else {
        this.addMemory(memory);
    }
}

=========================================
â‘¢ Firebase Storage ã®ãƒ«ãƒ¼ãƒ«
=========================================
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ«ãƒ¼ãƒ«
    match /images/{userId}/{allPaths=**} {
      // èª­ã¿å–ã‚Šã¯èª°ã§ã‚‚å¯èƒ½ï¼ˆå…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
      allow read: if true;
      // æ›¸ãè¾¼ã¿ã¯è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // å…¨ã¦ã®ç”»åƒã¸ã®èª­ã¿å–ã‚Šã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ï¼ˆCORSã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
    match /{allPaths=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}

=========================================
â‘£ è¡¨ç¤ºå´ã®HTMLï¼ˆç”»åƒè¡¨ç¤ºéƒ¨åˆ†ï¼‰
=========================================
${(memory.imageUrl || memory.image) ? `<img src="${memory.imageUrl || memory.image}" alt="æ€ã„å‡ºã®å†™çœŸ" class="memory-image">` : ''}

=========================================
â‘¤ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°å‡ºåŠ›ç®‡æ‰€
=========================================
- 1787è¡Œç›®: console.log('Saving memory:', { date, category, content, hasImage: !!imageFile });
- 1823è¡Œç›®: console.log('Memory object created:', memory);
- 1857è¡Œç›®: console.log('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:', imageUrl);
- 1861è¡Œç›®: console.log('âœ… ä¿å­˜ã•ã‚Œã‚‹URL:', memory.imageUrl);
- 2039è¡Œç›®: console.log('ğŸ–¼ï¸ è¡¨ç¤ºã™ã‚‹ç”»åƒURL:', memory.imageUrl);

=========================================
â‘¥ cors.json ã®ä¸­èº«
=========================================
[
  {
    "origin": ["https://www.memory-fragments.com"],
    "method": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    "maxAgeSeconds": 3600,
    "responseHeader": ["Content-Type", "Authorization"]
  }
]